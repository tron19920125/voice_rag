# 近似匹配精确性测试

## 🎯 测试目的

在实际 RAG 应用中，经常会遇到**近似但不同**的内容被错误匹配的问题。

例如用户的实际经验：
- 用户问 "mobile 空调"
- RAG 检索出 "mobile 空调" 和 "portable 空调"
- 模型可能混淆这些近似术语

本测试通过在知识库中加入干扰项，验证模型是否能**精确区分**相似内容。

---

## 📋 干扰项设计

### 1. 产品名称相似
| 正确产品 | 干扰产品 | 区别 |
|---------|---------|------|
| **FlowControl** | FlowMonitor | 控制器 vs 监控系统 |
| **FlowControl** | FlowModel | 控制器 vs 建模软件 |

### 2. 型号相似
| 标准型号 | 干扰型号 | 状态 |
|---------|---------|------|
| **X100** | X150 | 标准 vs 已停产 |
| **X500** | X550 | 标准 vs 定制 |

### 3. 客户名称相似
| 正确客户 | 干扰客户 | 业务差异 |
|---------|---------|---------|
| **蓝海电子制造** | 蓝天电子制造 | 预测性维护 vs 质量追溯 |
| **蓝海电子制造** | 蓝海电气工程 | 工业制造 vs 能源管理 |

---

## 💪 场景 5：近似匹配精确性测试

### 测试查询
```
我们需要采购控制器来管理生产线设备，
目前有 80 台设备，计划 1 年内扩展到 150 台。
我看到你们有 FlowControl-X500 和 FlowMonitor-M500，
还有 FlowModel 和 X150、X550 这些型号。

请问：
1. 这些产品有什么区别？
2. 我们应该选哪个？
3. 听说蓝海电子用你们的产品效果很好，能介绍下他们的案例吗？
```

### 正确答案要点

**1. 产品区分**
- ✅ FlowControl-X500：控制器，可以控制设备
- ✅ FlowMonitor-M500：监控系统，只能监控不能控制
- ✅ FlowModel：3D 建模软件，不是硬件
- ✅ X150：已停产，无法购买
- ✅ X550：定制产品，不适合一般客户

**2. 推荐方案**
- ✅ 应该推荐 **FlowControl-X500**（不是 FlowMonitor，不是 FlowModel）
- ✅ X500 支持 200+ 台设备，满足扩展需求
- ✅ 不应推荐 X150（已停产）或 X550（需定制）

**3. 案例引用**
- ✅ 应该引用**蓝海电子制造**的预测性维护案例
- ❌ 不应混淆**蓝天电子**（质量追溯）
- ❌ 不应混淆**蓝海电气**（能源管理）
- ✅ 关键数字：年节省 ¥3200 万，故障率下降 55%

---

## 🔍 评估标准

### 1. 产品名称精确性
```python
# 检查回答中是否正确区分
precision_checks = {
    "FlowControl": "必须说明是控制器",
    "FlowMonitor": "必须说明是监控系统，不能控制",
    "FlowModel": "必须说明是软件，不是硬件",
}
```

### 2. 型号精确性
```python
# 检查是否提到停产和定制信息
model_precision = {
    "X150": "必须说明已停产",
    "X550": "必须说明是定制产品",
    "X500": "应该是主要推荐"
}
```

### 3. 案例精确性
```python
# 检查是否混淆不同客户
case_precision = {
    "蓝海电子制造": {
        "correct_data": "¥3200 万，55%",
        "业务": "预测性维护"
    },
    "蓝天电子制造": {
        "correct_data": "¥120 万，14 个月",
        "业务": "质量追溯"
    },
    "蓝海电气工程": {
        "correct_data": "¥80 万，25%",
        "业务": "能源管理"
    }
}

# 如果用户问"蓝海电子"，回答中不应出现"蓝天电子"或"蓝海电气"的数据
```

---

## 🎯 预期结果对比

### 小模型可能的错误（8b）
- ❌ 混淆 FlowControl 和 FlowMonitor
- ❌ 混淆蓝海电子和蓝天电子的案例数据
- ❌ 推荐已停产的 X150

### 大模型的优势（32b/72b）
- ✅ 精确区分相似产品名称
- ✅ 正确引用对应客户的案例数据
- ✅ 明确说明停产和定制产品的状态

---

## 📊 评分机制

```python
def evaluate_precision(answer, query):
    """评估近似匹配精确性"""
    
    score = 0
    max_score = 0
    
    # 1. 产品区分（30分）
    if "FlowControl" in answer and "控制器" in answer:
        score += 10
    if "FlowMonitor" in answer and ("监控" in answer or "不能控制" in answer):
        score += 10
    if "FlowModel" in answer and "软件" in answer:
        score += 10
    max_score += 30
    
    # 2. 型号精确性（20分）
    if "X150" in answer and ("停产" in answer or "无法购买" in answer):
        score += 10
    if "X550" in answer and ("定制" in answer or "特殊" in answer):
        score += 10
    max_score += 20
    
    # 3. 推荐正确性（30分）
    if "X500" in answer and ("推荐" in answer or "适合" in answer):
        score += 30
    elif "X100" in answer:  # X100 也可以，但不是最优
        score += 15
    max_score += 30
    
    # 4. 案例精确性（20分）
    if "蓝海电子" in answer:
        if "3200" in answer or "55%" in answer:  # 正确数据
            score += 20
        elif "120" in answer or "80" in answer:  # 错误数据（其他公司的）
            score += 0  # 混淆了
    max_score += 20
    
    return score / max_score
```

---

## 🚨 常见混淆模式

### 模式 1：近义词混淆
```
用户："我需要 FlowControl 控制器"
RAG检索：FlowControl、FlowMonitor、FlowModel 都被检索出来
错误回答："FlowMonitor-M500 可以满足您的控制需求"
正确回答："您需要的是 FlowControl-X500 控制器，FlowMonitor 只能监控不能控制"
```

### 模式 2：数字混淆
```
用户："蓝海电子的案例效果如何？"
RAG检索：蓝海电子、蓝天电子、蓝海电气都被检索出来
错误回答："蓝海电子年节省 ¥120 万"（实际是蓝天电子的数据）
正确回答："蓝海电子制造年节省 ¥3200 万，故障率下降 55%"
```

### 模式 3：停产产品混淆
```
用户："X500 和 X150 有什么区别？"
RAG检索：X500、X150、X550 都被检索出来
错误回答："X150 适合 50-100 台设备的场景"
正确回答："X150 已于 2020 年停产，无法购买。建议选择 X500"
```

---

## 💡 测试意义

这个测试场景能够揭示：

1. **RAG 检索质量**
   - Reranking 是否能精确排序
   - Embedding 是否能区分细微差异

2. **模型理解能力**
   - 是否能理解"停产"、"定制"等状态
   - 是否能区分"控制"vs"监控"的功能差异

3. **模型规模影响**
   - 小模型（8b）可能简单匹配关键词
   - 大模型（32b/72b）可能有更强的语义理解

---

## 📝 总结

通过加入 6 个干扰文档，我们创造了一个**真实但有挑战性**的测试环境：

- **12 个文档**（6 个核心 + 6 个干扰）
- **5 个测试场景**（包含精确匹配测试）
- **真实模拟**生产环境中的近似匹配陷阱

这样的测试更能区分不同规模模型的实际能力！

---

## 🔤 近义词语义区分测试（新增）

### 背景
在实际应用中，近义词往往有细微但重要的区别，模型需要准确理解和区分。

### 新增的4组近义词干扰

#### 1. 监控 vs 监测
| 术语 | 英文 | 侧重点 | 典型应用 |
|------|------|--------|---------|
| **监控** | Supervision | 实时观察 + 控制 | 报警、可视化、响应 |
| **监测** | Monitoring | 数据采集 + 记录 | 传感器数据、趋势分析 |

**常见混淆**：
- 用户说"我需要监测设备"，可能实际需要的是"监控系统"
- FlowMonitor = 监控系统，FlowSense = 监测系统

#### 2. 效率 vs 效能
| 术语 | 英文 | 含义 | 举例 |
|------|------|------|------|
| **效率** | Efficiency | 投入产出比，做事快 | 单位时间产量 |
| **效能** | Effectiveness | 目标达成度，做对的事 | 订单满足率 |

**实际案例**：
- 光明食品：效率 95%（很高），但订单满足率 60%（效能低）
- 解决方案：不是提升效率，而是提升效能

#### 3. 维护 vs 保养
| 术语 | 英文 | 时机 | 成本特点 |
|------|------|------|---------|
| **维护** | Repair | 故障后修复 | 单次成本高，不可预测 |
| **保养** | Maintenance | 定期预防 | 持续投入，可预测 |

**术语扩展**：
- 预测性维护（Predictive Maintenance）
- 预防性保养（Preventive Maintenance）  
- 故障维护（Corrective Maintenance）

#### 4. 优化 vs 改进
| 术语 | 英文 | 范围 | 投资规模 |
|------|------|------|---------|
| **优化** | Optimization | 参数调整 | ¥10-20 万 |
| **改进** | Improvement | 流程重构 | ¥50-200 万 |

**案例对比**：
- 优化：注塑参数调整，良品率 92% → 97%
- 改进：流程重新设计，产能提升 2 倍

---

## 💪 场景 6：近义词语义区分测试

### 测试查询
```
我们工厂有以下需求：
1. 需要实时监控车间设备运行状态，但不知道该选监控系统还是监测系统？
2. 想提升生产效率，应该找效率提升方案还是效能提升方案？
3. 设备经常出故障，不知道该做维护管理还是保养管理？
4. 工艺参数不稳定，应该做流程优化还是流程改进？

请帮我们分析这些近义词的区别，并给出建议。
```

### 正确答案要点

**1. 监控 vs 监测**
- ✅ 需求：实时监控 → 应该选 **FlowMonitor 监控系统**
- ✅ 区别说明：监控=实时+报警，监测=数据采集
- ❌ 错误：推荐 FlowSense 监测系统

**2. 效率 vs 效能**
- ✅ 需要先确认：是产量问题还是目标达成问题
- ✅ 效率：单位时间产量 → 设备升级
- ✅ 效能：订单满足率 → 排产优化

**3. 维护 vs 保养**
- ✅ 问题：经常故障 → 应该建立 **保养体系**（预防）
- ✅ 区别说明：从被动维护转向主动保养
- ✅ 推荐：FlowCare 保养管理系统或预测性维护

**4. 优化 vs 改进**
- ✅ 问题：参数不稳定 → 应该做 **参数优化**
- ✅ 区别说明：优化在现有框架内，改进可能需要重构
- ✅ 推荐：FlowOpt 流程优化工具

---

## 📊 近义词区分评分

```python
def evaluate_synonym_distinction(answer, query):
    """评估近义词区分能力"""
    
    score = 0
    max_score = 0
    
    # 1. 监控 vs 监测（25分）
    if "监控" in answer and "实时" in answer:
        score += 10
    if "监测" in answer and "数据采集" in answer:
        score += 10
    if "区别" in answer or "不同" in answer:
        score += 5
    max_score += 25
    
    # 2. 效率 vs 效能（25分）
    if "效率" in answer and ("产量" in answer or "投入产出" in answer):
        score += 10
    if "效能" in answer and ("目标" in answer or "达成" in answer):
        score += 10
    if "光明食品" in answer:  # 引用案例
        score += 5
    max_score += 25
    
    # 3. 维护 vs 保养（25分）
    if "维护" in answer and ("故障" in answer or "修复" in answer):
        score += 10
    if "保养" in answer and ("预防" in answer or "定期" in answer):
        score += 10
    if "晨光机械" in answer:  # 引用案例
        score += 5
    max_score += 25
    
    # 4. 优化 vs 改进（25分）
    if "优化" in answer and "参数" in answer:
        score += 10
    if "改进" in answer and ("重构" in answer or "流程" in answer):
        score += 10
    if "FlowOpt" in answer:  # 推荐正确产品
        score += 5
    max_score += 25
    
    return score / max_score
```

---

## 🎯 测试意义升级

加入近义词测试后，我们可以验证：

### 1. 语义理解深度
- 小模型（8b）：可能只是简单匹配关键词
- 大模型（32b/72b）：能理解微妙的语义差异

### 2. 行业知识
- 是否理解工业领域的专业术语
- 是否能根据场景选择正确的术语

### 3. 推荐准确性
- 能否根据细微差异推荐正确的产品
- 能否引用正确的案例

---

## 📝 最终测试矩阵更新

```
知识库：16 个文档
- 6 个核心文档
- 6 个产品/客户名称相似文档
- 4 个近义词干扰文档

测试场景：6 个
- 场景1-4：原有高压测试
- 场景5：近似匹配精确性
- 场景6：近义词语义区分 🆕

总测试次数：6 场景 × 3 模型 × 2 模式 = 36 次
```

---

## 💡 实际价值

### 真实问题模拟
这些近义词混淆在实际业务中非常常见：
- 客户说"监测"，销售理解成"监控"
- 客户说"提升效率"，实际需要"提升效能"
- 客户说"做维护"，实际需要建立"保养体系"

### 模型能力验证
- 能否准确理解客户的真实需求
- 能否提供正确的产品推荐
- 能否避免误导客户

---

**近义词测试完成！现在有 16 个文档 + 6 个场景的完整测试集！** 🎉
